packer {
  required_plugins {
    azure = {
      source  = "github.com/hashicorp/azure"
      version = "~> 2"
    }
  }
}

variable "azure_client_id" {
  type = string
}

variable "azure_client_secret" {
  type      = string
  sensitive = true
}

variable "azure_tenant_id" {
  type = string
}

variable "azure_subscription_id" {
  type = string
}

variable "azure_resource_group_name" {
  type = string
}

variable "azure_vm_managed_identity_id" {
  type = string
}

variable "env_acr_name" {
  type = string
}

variable "env_acr_image_radius" {
  type = string
}

source "azure-arm" "autogenerated_1" {
  azure_tags = {
    dept = "Engineering"
    task = "Image deployment"
  }

  client_id                         = var.azure_client_id
  client_secret                     = var.azure_client_secret
  image_offer                       = "0001-com-ubuntu-server-jammy"
  image_publisher                   = "canonical"
  image_sku                         = "22_04-lts-gen2"
  managed_image_name                = "myPackerImage"
  managed_image_resource_group_name = var.azure_resource_group_name
  build_resource_group_name         = var.azure_resource_group_name
  os_type                           = "Linux"
  subscription_id                   = var.azure_subscription_id
  tenant_id                         = var.azure_tenant_id
  vm_size                           = "Standard_DS2_v2"
  user_assigned_managed_identities  = [var.azure_vm_managed_identity_id]
}

build {
  sources = [
    "source.azure-arm.autogenerated_1"
  ]

  provisioner "shell" {
    execute_command   = "chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh '{{ .Path }}'"
    script            = "ubuntu-jammy-build-gateway-01.sh"
    expect_disconnect = true
  }

  provisioner "shell" {
    execute_command = "chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh '{{ .Path }}'"
    script          = "ubuntu-jammy-build-gateway-02.sh"
    pause_before    = "10s"
    timeout         = "30s"
    environment_vars = [
      "ACR_NAME=${var.env_acr_name}",
      "ACR_IMAGE_RADIUS=${var.env_acr_image_radius}",
    ]
  }
}
