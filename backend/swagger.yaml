openapi: 3.0.3
info:
  title: Small KMS Admin API
  version: 0.1.0
servers:
  - url: http://localhost:9000
    description: Local server
paths:
  /v2/{namespaceId}/certificate-templates/{templateId}/certificates:
    parameters:
      - $ref: "#/components/parameters/NamespaceIdParameter"
      - $ref: "#/components/parameters/TemplateIdParameter"
    post:
      parameters:
        - $ref: "#/components/parameters/IncludeCertificateParameter"
          x-go-type-name: IncludeCertificateParameter
        - in: query
          name: "reuseKey"
          schema:
            type: boolean
      tags:
        - admin
      summary: Create certificate
      operationId: IssueCertificateByTemplateV2
      responses:
        200:
          $ref: "#/components/responses/CertificateResponse"
  /v2/{namespaceId}/certificate-templates/{templateId}/certificates/latest:
    parameters:
      - $ref: "#/components/parameters/NamespaceIdParameter"
      - $ref: "#/components/parameters/TemplateIdParameter"
      - $ref: "#/components/parameters/IncludeCertificateParameter"
    get:
      tags:
        - admin
      summary: Get certificate
      operationId: GetLatestCertificateByTemplateV2
      responses:
        200:
          $ref: "#/components/responses/CertificateResponse"
  /v2/{namespaceId}/certificate-templates/{templateId}/enroll:
    parameters:
      - $ref: "#/components/parameters/NamespaceIdParameter"
      - $ref: "#/components/parameters/TemplateIdParameter"
    post:
      tags:
        - enroll
      summary: Put certificate template
      operationId: BeginEnrollCertificateV2
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CertificateEnrollmentRequest"
        required: true
      responses:
        201:
          description: Certificate template response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CertificateEnrollmentReceipt"
        400:
          $ref: "#/components/responses/ErrorResponse"
  /v2/{namespaceId}/link-service-principal:
    parameters:
      - $ref: "#/components/parameters/NamespaceIdParameter"
    get:
      tags:
        - admin
      summary: Link device service principal
      operationId: GetDeviceServicePrincipalLinkV2
      responses:
        200:
          description: Link device service principal response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServicePrincipalLinkedDevice"
    post:
      tags:
        - admin
      summary: Link device service principal
      operationId: CreateDeviceServicePrincipalLinkV2
      responses:
        201:
          description: Link device service principal response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServicePrincipalLinkedDevice"
        400:
          $ref: "#/components/responses/ErrorResponse"
        409:
          $ref: "#/components/responses/ErrorResponse"
  /v2/{namespaceId}/certificates/{certId}:
    parameters:
      - $ref: "#/components/parameters/NamespaceIdParameter"
      - $ref: "#/components/parameters/CertIdParameter"
      - $ref: "#/components/parameters/IncludeCertificateParameter"
    get:
      tags:
        - admin
      summary: Get certificate
      operationId: GetCertificateV2
      responses:
        200:
          $ref: "#/components/responses/CertificateResponse"
  /v2/{namespaceId}/certificates/{certId}/pending:
    parameters:
      - $ref: "#/components/parameters/NamespaceIdParameter"
      - $ref: "#/components/parameters/CertIdParameter"
      - $ref: "#/components/parameters/IncludeCertificateParameter"
    post:
      tags:
        - enroll
      summary: complete certificate enrollment
      operationId: CompleteCertificateEnrollmentV2
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CertificateEnrollmentReplyFinalize"
        required: true
      responses:
        200:
          $ref: "#/components/responses/CertificateResponse"
        400:
          $ref: "#/components/responses/ErrorResponse"
  /v1/diagnostics:
    get:
      tags:
        - diagnostics
      summary: Get diagnostics
      operationId: GetDiagnosticsV1
      responses:
        "200":
          description: Diagnostics response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RequestDiagnostics"
security:
  - BearerAuth: []
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
  parameters:
    NamespaceIdParameter:
      in: path
      name: namespaceId
      schema:
        type: string
        format: uuid
      required: true
    NamespaceTypeParameter:
      in: query
      name: namespaceType
      schema:
        $ref: "#/components/schemas/NamespaceTypeShortName"
      required: true
    TemplateIdParameter:
      in: path
      name: templateId
      schema:
        type: string
        format: uuid
      required: true
    CertIdParameter:
      in: path
      name: certId
      schema:
        type: string
        format: uuid
      required: true
    IncludeCertificateParameter:
      in: query
      name: "includeCertificate"
      schema:
        $ref: "#/components/schemas/IncludeCertificate"
  schemas:
    IncludeCertificate:
      type: string
      enum:
        - jwk
        - pem
      x-enum-varnames:
        - IncludeJWK
        - IncludePEM
    NamespaceTypeShortName:
      type: string
      enum:
        - any
        - root-ca
        - intermediate-ca
        - service-principal
        - group
        - device
        - user
        - application
      x-enum-varnames:
        - NSType_Any
        - NSType_RootCA
        - NSType_IntCA
        - NSType_ServicePrincipal
        - NSType_Group
        - NSType_Device
        - NSType_User
        - NSType_Application
    CertificateIssuer:
      type: object
      properties:
        namespaceType:
          $ref: "#/components/schemas/NamespaceTypeShortName"
        namespaceId:
          type: string
          format: uuid
          x-go-name: NamespaceID
        templateId:
          description: if certificate ID is not specified, use template ID to find the latest certificate, use default value if not specified
          type: string
          format: uuid
          x-go-name: TemplateID
      required:
        - namespaceType
        - namespaceId
    RefType:
      type: string
      enum:
        - namespace
        - certificate-template
        - certificate
        - certificate-enrollment-receipt
      x-enum-varnames:
        - RefTypeNamespace
        - RefTypeCertificateTemplate
        - RefTypeCertificate
        - RefTypeCertificateEnrollReceipt
    Ref:
      type: object
      properties:
        namespaceId:
          type: string
          format: uuid
          x-go-name: NamespaceID
        type:
          $ref: "#/components/schemas/RefType"
        id:
          type: string
          format: uuid
          x-go-name: ID
      required:
        - namespaceId
        - type
        - id
    RefWithMetadata:
      allOf:
        - $ref: "#/components/schemas/Ref"
        - type: object
          properties:
            updatedBy:
              description: Unique ID of the user who last updated the object
              type: string
            updated:
              description: Time when the object was last updated
              type: string
              format: date-time
            deleted:
              description: Time when the object was deleted
              type: string
              format: date-time
            displayName:
              description: Display name of the object
              type: string
            isDefault:
              type: boolean
            isActive:
              type: boolean
          x-go-type-skip-optional-pointer: true
          required:
            - updated
            - updatedBy
            - displayName
    CertificateTemplateParameters:
      type: object
      description: Certificate fields, may accept template substitutions
      properties:
        displayName:
          type: string
        issuer:
          $ref: "#/components/schemas/CertificateIssuer"
        keyProperties:
          $ref: "#/components/schemas/JwkProperties"
        subjectCommoneName:
          description: Common name
          type: string
          x-go-name: SubjectCommonName
        usages:
          type: array
          items:
            $ref: "#/components/schemas/CertificateUsage"
        validity_months:
          x-go-name: ValidityInMonths
          type: integer
          format: int32
          minimum: 1
          maximum: 120
        keyStorePath:
          type: string
        lifetimeTrigger:
          $ref: "#/components/schemas/CertificateLifetimeTrigger"
        # reuse_key:
        #   description: Keep using the same key version if exists
        #   type: boolean
        #   x-go-name: ReuseKey
      required:
        - displayName
        - issuer
        - subjectCommoneName
        - usages
    CertificateTemplate:
      allOf:
        - type: object
          properties:
            ref:
              $ref: "#/components/schemas/RefWithMetadata"
          required:
            - ref
        - $ref: "#/components/schemas/CertificateTemplateParameters"
    CertificateEnrollmentTargetType:
      type: string
      enum:
        - device-linked-service-principal
      x-enum-varnames:
        - CertEnrollTargetTypeDeviceLinkedServicePrincipal
    CertificateEnrollmentRequestDeviceLinkedServicePrincipal:
      type: object
      properties:
        type:
          $ref: "#/components/schemas/CertificateEnrollmentTargetType"
        deviceNamespaceId:
          description: Object ID of the device
          type: string
          format: uuid
          x-go-name: DeviceNamespaceID
        linkId:
          description: Unique ID of the device link
          type: string
          format: uuid
          x-go-name: DeviceLinkID
        appId:
          description: Client ID of the application
          type: string
          format: uuid
          x-go-name: AppID
        servicePrincipalId:
          description: Object ID of the service principal
          type: string
          format: uuid
          x-go-name: ServicePrincipalID
        commonName:
          description: Common Name to appear in the certificate
          type: string
      required:
        - type
        - deviceNamespaceId
        - linkId
        - appId
        - servicePrincipalId
        - fqdn
    CertificateEnrollmentRequest:
      oneOf:
        - $ref: "#/components/schemas/CertificateEnrollmentRequestDeviceLinkedServicePrincipal"
      discriminator:
        propertyName: type
        mapping:
          device-linked-service-principal: "#/components/schemas/CertificateEnrollmentRequestDeviceLinkedServicePrincipal"
    CertificateEnrollmentReceipt:
      type: object
      properties:
        ref:
          $ref: "#/components/schemas/RefWithMetadata"
        expires:
          description: Time when the enrollment expires
          type: string
          format: date-time
        jwtClaims:
          description: payload section of the certificate claims, in JWT format, base64url encoded
          type: string
        templateNamespaceId:
          description: Unique ID of the namespace of the certificate template
          type: string
          format: uuid
          x-go-name: TemplateNamespaceID
        templateId:
          description: Consistent derived ID (UUID v5) of the certificate template
          type: string
          format: uuid
          x-go-name: TemplateID
        requesterId:
          description: Unique ID of the user who requested the certificate
          type: string
          format: uuid
          x-go-name: RequesterID
        keyProperties:
          $ref: "#/components/schemas/JwkProperties"
      required:
        - ref
        - expires
        - jwtClaims
        - templateNamespaceId
        - templateId
        - requesterId
        - keyProperties
    CertificateEnrollmentReplyFinalize:
      type: object
      properties:
        jwtHeader:
          description: header section of the certificate claims, in JWT format, base64url encoded
          type: string
        jwtSignature:
          description:
            signature section of the jwt, serves as proof of confirmation finalize the enrollment and being issued a certificate,
            with header and signature, signed with the key pair with the public key in the same request
          type: string
        publicKey:
          $ref: "#/components/schemas/JwkProperties"
      required:
        - jwtHeader
        - jwtSignature
        - publicKey
    NamespaceType:
      type: string
      enum:
        - "#builtin.ca.root"
        - "#builtin.ca.intermediate"
        - "#microsoft.graph.servicePrincipal"
        - "#microsoft.graph.user"
        - "#microsoft.graph.group"
        - "#microsoft.graph.device"
        - "#microsoft.graph.application"
      x-enum-varnames:
        - NamespaceType_BuiltInCaRoot
        - NamespaceType_BuiltInCaInt
        - NamespaceType_MsGraphServicePrincipal
        - NamespaceType_MsGraphUser
        - NamespaceType_MsGraphGroup
        - NamespaceType_MsGraphDevice
        - NamespaceType_MsGraphApplication
    NamespaceInfo:
      type: object
      properties:
        ref:
          $ref: "#/components/schemas/RefWithMetadata"
        objectType:
          $ref: "#/components/schemas/NamespaceTypeShortName"
      required:
        - ref
        - objectType
    ServicePrincipalLinkedDevice:
      type: object
      properties:
        ref:
          $ref: "#/components/schemas/RefWithMetadata"
        deviceOid:
          description: Object ID of the device
          type: string
          format: uuid
          x-go-name: DeviceOID
        deviceId:
          type: string
          format: uuid
          x-go-name: DeviceID
        applicationOid:
          description: Object ID of the application
          type: string
          format: uuid
          x-go-name: ApplicationOID
        applicationClientId:
          type: string
          format: uuid
          x-go-name: ApplicationClientID
        servicePrincipalId:
          type: string
          format: uuid
          x-go-name: ServicePrincipalID
        status:
          type: string
      required:
        - ref
        - deviceOid
        - deviceId
        - applicationClientId
        - applicationOid
        - servicePrincipalId
        - status
    CertificateSubject:
      type: object
      properties:
        cn:
          description: Common name
          type: string
          x-go-name: CN
        ou:
          description: Organizational unit
          type: string
          x-go-name: OU
        o:
          description: Organization
          type: string
        c:
          description: Country or region
          type: string
      required:
        - cn
    KeyProperties:
      type: object
      properties:
        kty:
          x-go-name: KeyType
          $ref: "#/components/schemas/JwtKty"
        key_size:
          x-go-name: KeySize
          $ref: "#/components/schemas/JwkKeySize"
        crv:
          $ref: "#/components/schemas/JwtCrv"
          x-go-name: CurveName
        reuse_key:
          description: Keep using the same key version if exists
          type: boolean
          x-go-name: ReuseKey
      required:
        - kty
    CertificateUsage:
      type: string
      enum:
        - root-ca
        - intermediate-ca
        - server-and-client
        - server-only
        - client-only
        - aad-client-credential
      x-enum-varnames:
        - Usage_RootCA
        - Usage_IntCA
        - Usage_ServerAndClient
        - Usage_ServerOnly
        - Usage_ClientOnly
        - Usage_AADClientCredential
    CertificateRef:
      allOf:
        - $ref: "#/components/schemas/ResourceRef"
        - title: CertificateRefParameters
          type: object
          properties:
            name:
              description: Name of the certificate, also the common name (CN) in the subject of the certificate
              type: string
            usage:
              $ref: "#/components/schemas/CertificateUsage"
            notAfter:
              description: Expiration date of the certificate
              type: string
              format: date-time
            issuerNamespace:
              description: Issuer namespace ID
              type: string
              format: uuid
            issuer:
              description: Issuer certificate ID
              type: string
              format: uuid
            createdBy:
              description: Unique ID of the user who created the certificate
              type: string
          required:
            - name
            - usage
            - notAfter
            - issuerNamespace
            - issuer
            - createdBy
    ResourceRef:
      type: object
      properties:
        namespaceId:
          description: Unique ID of the namespace
          type: string
          format: uuid
          x-go-name: NamespaceID
        id:
          type: string
          format: uuid
          x-go-name: ID
        updatedBy:
          description: Unique ID of the user who created the policy
          type: string
        updated:
          description: Time when the policy was last updated
          type: string
          format: date-time
        deleted:
          description: Time when the policy was deleted
          type: string
          format: date-time
      required:
        - namespaceId
        - id
        - updatedBy
        - updated
    PolicyStateCertRequest:
      type: object
      properties:
        lastCertId:
          type: string
          format: uuid
          x-go-name: LastCertID
        lastCertIssued:
          type: string
          format: date-time
        lastCertExpires:
          type: string
          format: date-time
        lastAction:
          type: string
      required:
        - lastCertId
        - lastCertIssued
        - lastCertExpires
        - lastAction
    CertificateLifetimeTrigger:
      type: object
      properties:
        days_before_expiry:
          x-go-name: DaysBeforeExpiry
          type: integer
          format: int32
        lifetime_percentage:
          x-go-name: LifetimePercentage
          type: integer
          format: int32
    CertificateSubjectAlternativeNames:
      type: object
      properties:
        emails:
          x-go-name: EmailAddresses
          type: array
          items:
            type: string
          x-go-type-skip-optional-pointer: true
        uris:
          x-go-name: URIs
          type: array
          items:
            type: string
          x-go-type-skip-optional-pointer: true
    JwkKeySize:
      type: integer
      format: int32
      enum:
        - 2048
        - 3072
        - 4096
      x-enum-varnames:
        - KeySize_2048
        - KeySize_3072
        - KeySize_4096
      x-go-name: KeySize
    CertificateRenewalParameters:
      type: object
      properties:
        renewalCertificateId:
          type: string
          format: uuid
        signature:
          type: string
          format: byte
    CertificateIssuerParameters:
      type: object
      properties:
        issuerNamespaceId:
          description: ID of the issuer namespace
          type: string
          format: uuid
          x-go-name: IssuerNamespaceID
        issuerPolicyIdentifier:
          description: ID of the issuer policy
          type: string
      required:
        - issuerNamespaceId
    CertificateRequestPolicyParameters:
      allOf:
        - $ref: "#/components/schemas/CertificateIssuerParameters"
        - type: object
          properties:
            keyProperties:
              $ref: "#/components/schemas/KeyProperties"
            subject:
              $ref: "#/components/schemas/CertificateSubject"
            subjectAlternativeNames:
              $ref: "#/components/schemas/CertificateSubjectAlternativeNames"
            usage:
              $ref: "#/components/schemas/CertificateUsage"
            validity_months:
              x-go-name: ValidityInMonths
              type: integer
              format: int32
            lifetimeTrigger:
              $ref: "#/components/schemas/CertificateLifetimeTrigger"
          required:
            - subject
            - usage
    CertificateIdentifierType:
      type: string
      enum:
        - certId
        - policyId
      x-enum-varnames:
        - CertIdTypeCertId
        - CertIdTypePolicyId
    CertificateLinks:
      type: object
      properties:
        id:
          description: Key Vault certificate ID
          type: string
        kid:
          description: Key Vault key ID
          type: string
        sid:
          description: Key Vault secret ID
          type: string
        certBlob:
          description: Certificate link in Blob
          type: string
    CertificateInfo:
      type: object
      properties:
        ref:
          $ref: "#/components/schemas/RefWithMetadata"
        commonName:
          description: Common name
          type: string
        subject:
          type: string
        subjectAlternativeNames:
          $ref: "#/components/schemas/CertificateSubjectAlternativeNames"
        notBefore:
          description: Expiration date of the certificate
          type: string
          format: date-time
        notAfter:
          description: Expiration date of the certificate
          type: string
          format: date-time
        usage:
          $ref: "#/components/schemas/CertificateUsage"
        jwk:
          $ref: "#/components/schemas/JwkProperties"
        pem:
          type: string
        template:
          $ref: "#/components/schemas/Ref"
        issuerCertificate:
          $ref: "#/components/schemas/Ref"
      required:
        - ref
        - commonName
        - subject
        - notBefore
        - notAfter
        - usage
        - content
        - template
        - issuerCertificate
    CertificateEnrollPolicyParameters:
      type: object
      properties:
        allowedUsages:
          type: array
          items:
            $ref: "#/components/schemas/CertificateUsage"
        maxValidityInMonths:
          type: integer
          format: int32
          minimum: 1
          maximum: 120
      required:
        - allowedUsages
        - maxValidityInMonths
    NamespaceRef:
      allOf:
        - $ref: "#/components/schemas/ResourceRef"
        - type: object
          properties:
            objectType:
              $ref: "#/components/schemas/NamespaceType"
            displayName:
              type: string
          required:
            - objectType
            - displayName
    NamespaceProfile:
      allOf:
        - $ref: "#/components/schemas/NamespaceRef"
        - type: object
          properties:
            servicePrincipalType:
              type: string
            userPrincipalName:
              type: string
            deviceOwnership:
              type: string
            deviceId:
              description: \#microsoft.graph.device deviceId
              x-go-name: DeviceID
              type: string
            operatingSystem:
              description: \#microsoft.graph.device operatingSystem
              type: string
            operatingSystemVersion:
              description: \#microsoft.graph.device operatingSystemVersion
              type: string
            isCompliant:
              description: \#microsoft.graph.device isCompliant
              type: boolean
            appId:
              description: \#microsoft.graph.application appId
              x-go-name: AppID
              type: string
    RequestHeaderEntry:
      type: object
      properties:
        key:
          type: string
        value:
          type: array
          items:
            type: string
      required:
        - key
        - value
    RequestDiagnostics:
      type: object
      properties:
        requestHeaders:
          type: array
          items:
            $ref: "#/components/schemas/RequestHeaderEntry"
        serviceRuntime:
          type: object
          title: ServiceRuntime
          properties:
            goVersion:
              type: string
          required:
            - goVersion
          additionalProperties:
            type: string
      required:
        - requestHeaders
        - serviceRuntime
    MyProfile:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/NamespaceProfile"
        device:
          $ref: "#/components/schemas/NamespaceProfile"
    NamespacePermissionKey:
      type: string
      enum:
        - allowEnrollDeviceCertificate
    NamespacePermissions:
      type: object
      properties:
        allowEnrollDeviceCertificate:
          type: boolean
    JwkAlg:
      type: string
      enum:
        - RS256
        - RS384
        - RS512
        - ES256
        - ES384
      x-enum-varnames:
        - AlgRS256
        - AlgRS384
        - AlgRS512
        - AlgES256
        - AlgES384
    JwtKty:
      type: string
      enum:
        - RSA
        - EC
      x-enum-varnames:
        - KeyTypeRSA
        - KeyTypeEC
    JwtCrv:
      type: string
      enum:
        - P-256
        - P-384
      x-enum-varnames:
        - CurveNameP256
        - CurveNameP384
    JwkKeyOperation:
      type: string
      enum:
        - sign
        - verify
        - encrypt
        - decrypt
        - wrapKey
        - unwrapKey
      x-enum-varnames:
        - KeyOpSign
        - KeyOpVerify
        - KeyOpEncrypt
        - KeyOpDecrypt
        - KeyOpWrapKey
        - KeyOpUnwrapKey
      x-go-name: KeyOp          
    JwkProperties:
      type: object
      description: Property bag of JSON Web Key (RFC 7517) with additional fields, all bytes are base64url encoded
      properties:
        alg:
          $ref: "#/components/schemas/JwkAlg"
        kty:
          $ref: "#/components/schemas/JwtKty"
        key_size:
          description: RSA key size
          type: integer
        key_ops:
          $ref: "#/components/schemas/JwkKeyOperation"
        n:
          description: RSA modulus
          type: string
        e:
          description: RSA exponent
          type: string
        crv:
          $ref: "#/components/schemas/JwtCrv"
        x:
          description: EC x coordinate
          type: string
        y:
          description: EC y coordinate
          type: string
        kid:
          description: Key ID
          type: string
          x-go-name: KeyID
        x5u:
          x-go-name: CertificateURL
          description: X.509 certificate URL
          type: string
        x5c:
          description: X.509 certificate chain
          type: array
          items:
            type: string
          x-go-name: CertificateChain
          x-go-type-skip-optional-pointer: true
        x5t:
          description: X.509 certificate SHA-1 thumbprint
          type: string
          x-go-name: CertificateThumbprint
        x5t#S256:
          description: X.509 certificate SHA-256 thumbprint
          type: string
          x-go-name: CertificateThumbprintSHA256
      required:
        - kty          
  responses:
    RefListResponse:
      description: List RefsResponse
      content:
        application/json:
          schema:
            type: array
            items:
              $ref: "#/components/schemas/RefWithMetadata"
    CertificateResponse:
      description: CertificateResponse
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CertificateInfo"
    GenericResponse:
      description: generic response
      content:
        application/json:
          schema:
            type: object
            additionalProperties: true
    ErrorResponse:
      description: error response
      content:
        application/json:
          schema:
            type: object
            additionalProperties: true
